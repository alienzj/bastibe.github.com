<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Org Mode Selective Section Numbering</title>
<!-- 2014-11-26 Wed 14:00 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Bastian Bechtold" />
<link rel="alternate" type="appliation/rss+xml"
                href="http://bastibe.de/rss.xml"
                title="RSS feed for bastibe.de">
          <link href='http://fonts.googleapis.com/css?family=Roboto&subset=latin' rel='stylesheet' type='text/css'>
          <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
          <link href= "static/style.css" rel="stylesheet" type="text/css" />
          <link rel="icon" href="static/favicon.ico">
          <link rel="apple-touch-icon-precomposed" href="static/favicon-152.png">
          <link rel="msapplication-TitleImage" href="static/favicon-144.png">
          <link rel="msapplication-TitleColor" href="#0141ff">
          <title>Basti's Scratchpad on the Internet</title>
          <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
          <meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1">
</head>
<body>
<div id="preamble" class="status">
<div class="header">
              <a href="http://bastibe.de">Basti's Scratchpad on the Internet</a>
              <div class="sitelinks">
                  <a href="http://alpha.app.net/bastibe">alpha.app.net</a>  | <a href="http://github.com/bastibe">Github</a>
              </div>
          </div>
</div>
<div id="content">
<h1 class="title">Org Mode Selective Section Numbering</h1>
<p>
If you write in Org mode and export to LaTeX, you might have stumbled upon one major limitation: Org mode can either number all headlines, or none. In scientific writing, this is a non-starter.
</p>

<p>
In a scientific paper, the abstract should not be numbered, the main body should be numbered, and appendices should not be numbered. This is easy to do in LaTeX, but not in Org mode. On the other hand, this is Emacs, so everything is possible:
</p>

<div class="org-src-container">

<pre class="src src-elisp">(<span style="color: #718c00;">defun</span> <span style="color: #f5871f;">headline-numbering-filter</span> (data backend info)
  <span style="color: #8959a8;">"No numbering in headlines that have a property :numbers: no"</span>
  (<span style="color: #718c00;">let*</span> ((beg (next-property-change 0 data))
         (headline (<span style="color: #718c00;">if</span> beg (get-text-property beg <span style="color: #8959a8;">:parent</span> data))))
    (<span style="color: #718c00;">if</span> (and (eq backend 'latex)
         (string= (org-element-property <span style="color: #8959a8;">:NUMBERS</span> headline) <span style="color: #3e999f;">"no"</span>))
        (replace-regexp-in-string
         <span style="color: #3e999f;">"</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">(</span><span style="color: #3e999f;">part</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">|</span><span style="color: #3e999f;">chapter</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">|</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">(?:</span><span style="color: #3e999f;">sub</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">)</span><span style="color: #3e999f;">*section</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">|</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">(?:</span><span style="color: #3e999f;">sub</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">)</span><span style="color: #3e999f;">?paragraph</span><span style="color: #eab700;">\\</span><span style="color: #8959a8;">)</span><span style="color: #3e999f;">"</span>
         <span style="color: #3e999f;">"\\1*"</span> data nil nil 1)
      data)))

(setq org-export-filter-headline-functions '(headline-numbering-filter))
</pre>
</div>

<p>
This defines a function and registers that function to be called for every headline. If that headline has a property <code>:NUMBERS: no</code>, it will disable numbering in the LaTeX output.
</p>

<p>
For example, <code>* HEADLINE</code> will be exported as <code>\section{HEADLINE}</code>, while
</p>

<pre class="example">
* HEADLINE
:PROPERTIES:
:NUMBERS: no
:END:
</pre>

<p>
will be exported as <code>\section*{HEADLINE}</code>.
</p>

<p>
<b>EDIT:</b> The above approach has a number of downsides. Most importantly, it only works for the LaTeX export, but not any other backend.
</p>

<p>
Instead of using filters to manually transform the output, one can advise the numbering function themself:
</p>

<div class="org-src-container">

<pre class="src src-elisp">(<span style="color: #718c00;">defun</span> <span style="color: #f5871f;">unnumber-unnumbered-headlines</span> (orig headline info)
  <span style="color: #8959a8;">"remove headline numbers for headlines that are</span>
<span style="color: #8959a8;">marked :numbers: no."</span>
    (and (funcall orig headline info)
         (not (string= (org-element-property <span style="color: #8959a8;">:NUMBERS</span> headline) <span style="color: #3e999f;">"no"</span>))))

(advice-add 'org-export-numbered-headline-p <span style="color: #8959a8;">:around</span> 'unnumber-unnumbered-headlines)
</pre>
</div>

<p>
This works for all export types, but won't change the table of contents (except in LaTeX, where the TOC is created by LaTeX itself). In order to exclude unnumbered sections from the TOC, another function can be advised:
</p>

<div class="org-src-container">

<pre class="src src-elisp">(<span style="color: #718c00;">defun</span> <span style="color: #f5871f;">filter-unnumbered-headlines</span> (headlines)
  <span style="color: #8959a8;">"suppress headline numbers in toc for headlines that are</span>
<span style="color: #8959a8;">marked :numbers: no."</span>
  (cl-remove-if (<span style="color: #718c00;">lambda</span> (headline) (string= (org-element-property <span style="color: #8959a8;">:NUMBERS</span> headline) <span style="color: #3e999f;">"no"</span>)) headlines))

(advice-add 'org-export-collect-headlines <span style="color: #8959a8;">:filter-return</span> 'filter-unnumbered-headlines)
</pre>
</div>

<p>
While this suppresses the numbers, Org will still number headlines as if every headline were numbered. The following advice can be used to correct that. Note that hidden numbers will occur twice in the internal numbers, which might break some links.
</p>

<div class="org-src-container">

<pre class="src src-elisp">(<span style="color: #718c00;">defun</span> <span style="color: #f5871f;">skip-unnumbered-headlines</span> (orig headline info)
  <span style="color: #8959a8;">"decrement headline numbers to skip headlines that are</span>
<span style="color: #8959a8;">marked :numbers: no."</span>
  (<span style="color: #718c00;">let</span> ((unnumbered-headlines 0)
        (headlines (plist-get info <span style="color: #8959a8;">:headline-numbering</span>))
        (headline-number (funcall orig headline info)))
    <span style="color: #8e908c; font-style: italic;">;; </span><span style="color: #8e908c; font-style: italic;">count unnumbered headlines</span>
    (<span style="color: #718c00;">while</span> (not (eq headline (caar headlines)))
      (<span style="color: #718c00;">if</span> (and (string= (org-element-property <span style="color: #8959a8;">:NUMBERS</span> (caar headlines)) <span style="color: #3e999f;">"no"</span>)
               <span style="color: #8e908c; font-style: italic;">;; </span><span style="color: #8e908c; font-style: italic;">only search at the same level as headline</span>
               (eq (org-element-property <span style="color: #8959a8;">:parent</span> headline)
                   (org-element-property <span style="color: #8959a8;">:parent</span> (caar headlines))))
          (setq unnumbered-headlines (1+ unnumbered-headlines)))
      (setq headlines (cdr headlines)))
    <span style="color: #8e908c; font-style: italic;">;; </span><span style="color: #8e908c; font-style: italic;">create new number</span>
    (<span style="color: #718c00;">let</span> ((new-number (copy-tree headline-number)))
      (setcar (last new-number) (- (car (last new-number)) unnumbered-headlines))
      new-number)))

(advice-add 'org-export-get-headline-number <span style="color: #8959a8;">:around</span> 'skip-unnumbered-headlines)
</pre>
</div>

<p>
While that is quite a piece of work, it exports correctly in both LaTeX and HTML.
</p>
</div>
<div id="postamble" class="status">
<div id="archive"><a href="archive.html">Other posts</a></div>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
              /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
              var disqus_shortname = 'bastibe';
              /* * * DON'T EDIT BELOW THIS LINE * * */
              (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              </script>
              <noscript>Please enable JavaScript to view the
                  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<center><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">bastibe.de</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://bastibe.de" property="cc:attributionName" rel="cc:attributionURL">Bastian Bechtold</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</center>
</div>
</body>
</html>
