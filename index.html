<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bastis Scratchpad On The Internet</title>
    <meta name="description" content="">
    <meta name="author" content="Bastian Bechtold">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="./theme/bootstrap.min.css" rel="stylesheet">
    <link href="./theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="./theme/local.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">

    <script language="javascript">
    if(window.MathJax===undefined){
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src  = "http://cdn.mathjax.org/mathjax/latest/MathJax.js";
        var config = 'MathJax.Hub.Config({' +
                    'extensions: ["tex2jax.js"],' +
                    'tex2jax: { '+
                      'inlineMath: [ ["$","$"]], '+
                      'displayMath: [["\\[","\\]"]],'+
                      'processEscapes: true '+
                    '},' +
                    'jax: ["input/TeX","output/HTML-CSS"]' +
                    '});' +
                    'MathJax.Hub.Startup.onload();';
        if (window.opera)
            script.innerHTML = config;
        else
            script.text = config;
        document.getElementsByTagName("head")[0].appendChild(script);
    }
    </script>
</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href=".">Bastis Scratchpad On The Internet</a>

        <div class="nav-collapse">
        <ul class="nav">
        

        
        
        
        </ul>
        </div>

    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
                


        




    <div class='article'>
        <div class="content-title">
            <a href="./real-time-signal-processing-in-python.html"><h1>Real Time Signal Processing in Python</h1></a>
            02/11/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 
        </div>
        
        <div><p>Wouldn't it be nice if you could do real time audio processing in a convenient programming language? Matlab comes to mind as a convenient language for signal processing. But while Matlab is pretty fast, it is really only fast for algorithms that can be vectorized. In audio however, we have many algorithms that need knowledge about the previous sample to calculate the next one, so they can't be vectorized.</p>
<p>But this is not going to be about Matlab. This is going to be about Python. Combine Python with Numpy (and Scipy and Matplotlib) and you have a signal processing system very comparable to Matlab. Additionally, you can do real-time audio input/output using PyAudio. PyAudio is a wrapper around PortAudio and provides cross platform audio recording/playback in a nice, pythonic way. (Real time capabilities were added in 0.2.6 with the help of yours truly).</p>
<p>However, this does not solve the problem with vectorization. Just like Matlab, Python/Numpy is only fast for vectorizable algorithms. So as an example, let's define an iterative algorithm that is not vectorizable:</p>
<h2>A Simple Limiter</h2>
<p>A limiter is an audio effect that controls the system gain so that it does not exceed a certain threshold level. One could do this by simply cutting off any signal peaks above that level, but that sounds awful. So instead, the whole system gain is reduced smoothly if the signal gets too loud and is amplified back to its original gain again when it does not exceed the threshold any more. The important part is that the gain change is done <em>smoothly</em>, since otherwise it would introduce a lot of distortion.</p>
<p>If a signal peak is detected, the limiter will thus need a certain amount of time to reduce the gain accordingly. If you still want to prevent all peaks, the limiter will have to know of the peaks in advance, which is of course impossible in a real time system. Instead, the signal is delayed by a short time to give the limiter time to adjust the system gain before the peak is actually played. To keep this delay as short as possible, this "attack" phase where the gain is decreased should be very short, too. "Releasing" the gain back up to its original value can be done more slowly, thus introducing less distortion.</p>
<p>With that out of the way, let me present you a simple implementation of such a limiter. First, lets define a signal envelope $e[n]$ that catches all the peaks and smoothly decays after them:</p>
<p>$ e[n] = \max( |s[n]|, e[n-1] \cdot f_r ) $</p>
<p>where $s[n]$ is the current signal and $0 &lt; f_r &lt; 1$ is a release factor.</p>
<p>If this is applied to a signal, it will create an envelope like this:</p>
<p><img alt="Envelope" src="static/images/2012-11/envelope.png" /></p>
<p>Based on that envelope, and assuming that the signal ranges from -1 to 1, the target gain $g_t[n]$ can be calculated using</p>
<p>\begin{equation}
g_t[n] = \begin{cases}
    1 &amp; e[n] &lt; t \\
    1 + t - e[n] &amp; e[n] &gt; t
\end{cases}
\end{equation}</p>
<p>Now, the output gain $g[n]$ can smoothly move towards that target gain using</p>
<p>$ g[n] = g[n-1] \cdot f_a + g_t[n] \cdot (1-f_a) $</p>
<p>where $0 &lt; f_a \ll f_r$ is the attack factor.</p>
<p>Here you can see how that would look in practice:</p>
<p><img alt="Gain" src="static/images/2012-11/gain.png" /></p>
<p>Zooming in on one of the limited section reveals that the gain is actually moving smoothly.</p>
<p><img alt="Detail Gain" src="static/images/2012-11/detail.png" /></p>
<p>This gain can now be multiplied on the delayed input signal and will safely keep that below the threshold.</p>
<p>In Python, this might look like this:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">Limiter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attack_coeff</span><span class="p">,</span> <span class="n">release_coeff</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envelope</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_line</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_coeff</span> <span class="o">=</span> <span class="n">release_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attack_coeff</span> <span class="o">=</span> <span class="n">attack_coeff</span>

    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delay_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delay_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>

            <span class="c"># calculate an envelope of the signal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envelope</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_coeff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">envelope</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">envelope</span><span class="p">)</span>

            <span class="c"># have self.gain go towards a desired limiter gain</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">envelope</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">target_gain</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">threshold</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">envelope</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_gain</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">attack_coeff</span> <span class="o">+</span>
                          <span class="n">target_gain</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">attack_coeff</span><span class="p">)</span> <span class="p">)</span>

            <span class="c"># limit the delayed signal</span>
            <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_index</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span>
</pre></div>


<p>Note that this limiter does not <em>actually</em> clip all peaks completely, since the envelope for a single peak will have decayed a bit before the target gain will have reached it. Thus, the output gain will actually be slightly higher than what would be necessary to limit the output to the threshold. Since the attack factor is supposed to be significantly smaller than the release factor, this does not matter much though.</p>
<p>Also, it would probably be more useful to define the factors $f_a$ and $f_r$ in terms of the time they take to reach their target and the threshold $t$ in dB FS.</p>
<h2>Implementing audio processing in Python</h2>
<p>A real-time audio processing framework using PyAudio would look like this:</p>
<p>(<code>callback</code> is a function that will be defined shortly)</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">pyaudio</span> <span class="kn">import</span> <span class="n">PyAudio</span><span class="p">,</span> <span class="n">paFloat32</span>

<span class="n">pa</span> <span class="o">=</span> <span class="n">PyAudio</span><span class="p">()</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">format</span> <span class="o">=</span> <span class="n">paFloat32</span><span class="p">,</span>
                 <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">,</span>
                 <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">frames_per_buffer</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
                 <span class="n">stream_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">)</span>

<span class="k">while</span> <span class="n">stream</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pa</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>


<p>This will open a <code>stream</code>, which is a PyAudio construct that manages input and output to/from one sound device. In this case, it is configured to use <code>float</code> values, only open one channel, play audio at a sample rate of 44100 Hz, have that one channel be output only and call the function <code>callback</code> every 1024 samples.</p>
<p>Since the <code>callback</code> will be executed on a different thread, control flow will continue immediately after <code>pa.open()</code>. In order to analyze the resulting signal, the <code>while stream.is_active()</code> loop waits until the signal has been processed completely.</p>
<p>Every time the <code>callback</code> is called, it will have to return 1024 samples of audio data. Using the class <code>Limiter</code> above, a sample counter <code>counter</code> and an audio signal <code>signal</code>, this can be implemented like this:</p>
<div class="codehilite"><pre><span class="n">limiter</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span><span class="n">attack_coeff</span><span class="p">,</span> <span class="n">release_coeff</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">in_data</span><span class="p">,</span> <span class="n">frame_count</span><span class="p">,</span> <span class="n">time_info</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Playback Error: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">flag</span><span class="p">)</span>
    <span class="n">played_frames</span> <span class="o">=</span> <span class="n">counter</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="n">frame_count</span>
    <span class="n">limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">played_frames</span><span class="p">:</span><span class="n">counter</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">signal</span><span class="p">[</span><span class="n">played_frames</span><span class="p">:</span><span class="n">counter</span><span class="p">],</span> <span class="n">paContinue</span>
</pre></div>


<p>The <code>paContinue</code> at the end is a flag signifying that the audio processing is not done yet and the <code>callback</code> wants to be called again. Returning <code>paComplete</code> or an insufficient number of samples instead would stop audio processing after the current block and thus invalidate <code>stream.is_active()</code> and resume control flow in the snippet above.</p>
<p>Now this will run the limiter and play back the result. Sadly however, Python is just a bit too slow to make this work reliably. Even with a long block size of 1024 samples, this will result in occasional hickups and discontinuities. (Which the <code>callback</code> will display in the <code>print(...)</code> statement).</p>
<h2>Speeding up execution using Cython</h2>
<p>The limiter defined above could be rewritten in C like this:</p>
<div class="codehilite"><pre><span class="c1">// this corresponds to the Python Limiter class.</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">limiter_state_t</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">delay_index</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">delay_length</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">envelope</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">current_gain</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">attack_coeff</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">release_coeff</span><span class="p">;</span>
<span class="p">}</span> <span class="n">limiter_state</span><span class="p">;</span>

<span class="cp">#define MAX(x,y) ((x)&gt;(y)?(x):(y))</span>

<span class="c1">// this corresponds to the Python __init__ function.</span>
<span class="n">limiter_state</span> <span class="nf">init_limiter</span><span class="p">(</span><span class="kt">float</span> <span class="n">attack_coeff</span><span class="p">,</span> <span class="kt">float</span> <span class="n">release_coeff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">limiter_state</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">attack_coeff</span> <span class="o">=</span> <span class="n">attack_coeff</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">release_coeff</span> <span class="o">=</span> <span class="n">release_coeff</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">delay_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">envelope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">current_gain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">delay_length</span> <span class="o">=</span> <span class="n">delay_len</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">limit</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">signal</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_length</span><span class="p">,</span> <span class="kt">float</span> <span class="n">threshold</span><span class="p">,</span>
           <span class="kt">float</span> <span class="o">*</span><span class="n">delay_line</span><span class="p">,</span> <span class="n">limiter_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">block_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">delay_line</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delay_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">delay_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delay_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">delay_length</span><span class="p">;</span>

        <span class="c1">// calculate an envelope of the signal</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">envelope</span> <span class="o">*=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">release_coeff</span><span class="p">;</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">envelope</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">envelope</span><span class="p">);</span>

        <span class="c1">// have current_gain go towards a desired limiter target_gain</span>
        <span class="kt">float</span> <span class="n">target_gain</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">envelope</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="n">target_gain</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">threshold</span><span class="o">-</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">envelope</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">target_gain</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
        <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span><span class="o">*</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">attack_coeff</span> <span class="o">+</span>
            <span class="n">target_gain</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">attack_coeff</span><span class="p">);</span>

        <span class="c1">// limit the delayed signal</span>
        <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay_line</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">delay_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>In contrast to the Python version, the delay line will be passed to the <code>limit</code> function. This is advantageous because now all audio buffers can be managed by Python instead of manually allocating and deallocating them in C.</p>
<p>Now in order to plug this code into Python I will use Cython. First of all, a "Cython header" file has to be created that declares all exported types and functions to Cython:</p>
<div class="codehilite"><pre><span class="n">cdef</span> <span class="n">extern</span> <span class="kn">from</span> <span class="err">&quot;</span><span class="nn">limiter.h</span><span class="err">&quot;:</span>
    <span class="n">ctypedef</span> <span class="n">struct</span> <span class="n">limiter_state</span><span class="p">:</span>
        <span class="nb">int</span> <span class="n">delay_index</span>
        <span class="nb">int</span> <span class="n">delay_length</span>
        <span class="nb">float</span> <span class="n">envelope</span>
        <span class="nb">float</span> <span class="n">current_gain</span>
        <span class="nb">float</span> <span class="n">attack_coeff</span>
        <span class="nb">float</span> <span class="n">release_coeff</span>

    <span class="n">limiter_state</span> <span class="n">init_limiter</span><span class="p">(</span><span class="nb">float</span> <span class="n">attack_factor</span><span class="p">,</span> <span class="nb">float</span> <span class="n">release_factor</span><span class="p">,</span> <span class="nb">int</span> <span class="n">delay_len</span><span class="p">)</span>
    <span class="n">void</span> <span class="n">limit</span><span class="p">(</span><span class="nb">float</span> <span class="o">*</span><span class="n">signal</span><span class="p">,</span> <span class="nb">int</span> <span class="n">block_length</span><span class="p">,</span> <span class="nb">float</span> <span class="n">threshold</span><span class="p">,</span>
               <span class="nb">float</span> <span class="o">*</span><span class="n">delay_line</span><span class="p">,</span> <span class="n">limiter_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
</pre></div>


<p>This is very similar to the C header file of the limiter:</p>
<div class="codehilite"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">limiter_state_t</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">delay_index</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">delay_length</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">envelope</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">current_gain</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">attack_coeff</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">release_coeff</span><span class="p">;</span>
<span class="p">}</span> <span class="n">limiter_state</span><span class="p">;</span>

<span class="n">limiter_state</span> <span class="n">init_limiter</span><span class="p">(</span><span class="kt">float</span> <span class="n">attack_factor</span><span class="p">,</span> <span class="kt">float</span> <span class="n">release_factor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">limit</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">signal</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_length</span><span class="p">,</span> <span class="kt">float</span> <span class="n">threshold</span><span class="p">,</span>
           <span class="kt">float</span> <span class="o">*</span><span class="n">delay_line</span><span class="p">,</span> <span class="n">limiter_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
</pre></div>


<p>With that squared away, the C functions are accessible for Cython. Now, we only need a small Python wrapper around this code so it becomes usable from Python:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">cimport</span> <span class="n">limiter</span>

<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
<span class="n">ctypedef</span> <span class="n">np</span><span class="o">.</span><span class="n">float32_t</span> <span class="n">DTYPE_t</span>

<span class="n">cdef</span> <span class="k">class</span> <span class="nc">Limiter</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="n">limiter</span><span class="o">.</span><span class="n">limiter_state</span> <span class="n">state</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">delay_line</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">float</span> <span class="n">attack_coeff</span><span class="p">,</span> <span class="nb">float</span> <span class="n">release_coeff</span><span class="p">,</span>
                 <span class="nb">int</span> <span class="n">delay_length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">limiter</span><span class="o">.</span><span class="n">init_limiter</span><span class="p">(</span><span class="n">attack_coeff</span><span class="p">,</span> <span class="n">release_coeff</span><span class="p">,</span> <span class="n">delay_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">delay_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">DTYPE_t</span><span class="p">,</span><span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">signal</span><span class="p">,</span> <span class="nb">float</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="n">limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">*&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">PyArray_DATA</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span>
                   <span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="n">threshold</span><span class="p">,</span>
                   <span class="o">&lt;</span><span class="nb">float</span><span class="o">*&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">PyArray_DATA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_line</span><span class="p">),</span>
                   <span class="o">&lt;</span><span class="n">limiter</span><span class="o">.</span><span class="n">limiter_state</span><span class="o">*&gt;&amp;</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</pre></div>


<p>The first two lines set this file up to access Numpy arrays both from the Python domain and the C domain, thus bridging the gap. The <code>cimport limiter</code> imports the C functions and types from above. The <code>DTYPE</code> stuff is advertising the Numpy <code>float32</code> type to C.</p>
<p>The class is defined using <code>cdef</code> as a C data structure for speed. Also, Cython would naturally translate every C struct into a Python dict and vice versa, but we need to pass the struct to <code>limit</code> <em>and</em> have <code>limit</code> modify it. Thus, <code>cdef limiter.limiter_state state</code> makes Cython treat it as a C struct only. Finally, the <code>np.PyArray_DATA()</code> expressions expose the C arrays underlying the Numpy vectors. This is really handy since we don't have to copy any data around in order to modify the vectors from C.</p>
<p>As can be seen, the Cython implementation behaves nearly identically to the initial Python implementation (except for passing the <code>dtype</code> to the constructor) and can be used as a plug-in replacement (with the aforementioned caveat).</p>
<p>Finally, we need to build the whole contraption. The easiest way to do this is to use a setup file like this:</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">distutils.extension</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">Cython.Distutils</span> <span class="kn">import</span> <span class="n">build_ext</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">get_include</span>

<span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s">&quot;cython_limiter&quot;</span><span class="p">,</span>
                         <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;cython_limiter.pyx&quot;</span><span class="p">,</span>
                                  <span class="s">&quot;limiter.c&quot;</span><span class="p">],</span>
                         <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">get_include</span><span class="p">()])]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cython_limiter&quot;</span><span class="p">,</span>
    <span class="n">cmdclass</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;build_ext&#39;</span><span class="p">:</span> <span class="n">build_ext</span><span class="p">},</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">ext_modules</span>
    <span class="p">)</span>
</pre></div>


<p>With that saved as <em>setup.py</em>, <code>python setup.py build_ext --inplace</code> will convert the Cython code to C, and then compile both the converted Cython code and C code into a binary Python module.</p>
<h2>Conclusion</h2>
<p>In this article, I developed a simple limiter and how to implement it in both C and Python. Then, I showed how to use the C implementation from Python. Where the Python implementation is struggling to keep a steady frame rate going even at large block sizes, the Cython version runs smoothly down to 2-4 samples per block on a 2 Ghz Core i7. Thus, real-time audio processing is clearly feasable using Python, Cython, Numpy and PyAudio.</p>
<p>You can find all the source code in this article at https://github.com/bastibe/simple-cython-limiter</p>
<h2>Disclaimer</h2>
<ol>
<li>I invented this limiter myself. I could invent a better sounding limiter, but this article is more about how to combine Python, Numpy, PyAudio and Cython for real-time signal processing than about limiter design.</li>
<li>I recently worked on something similar at my day job. They agreed that I could write about it so long as I don't divulge any company secrets. This limiter is not a descendant of any code I worked on.</li>
<li>Whoever wants to use any piece of code here, feel free to do so. I am hereby placing it in the public domain. Feel free to contact me if you have questions.</li>
</ol></div>
        <hr />
    </div>
		
    


 

        


 

    <div class='article'>
        <a href="./an-error-occurred-loading-this-content-try-again-later.html"><h2>An error occurred loading this content. Try again later.</h2></a>
        <div class= "well small"> 01/11/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>Since we moved, our Apple TV has been giving us trouble: we would rent a movie on the Apple TV, and instead of playing it, the Apple TV would just display</p>
<blockquote>
<p>An error occurred loading this content.
Try again later.</p>
</blockquote>
<p>Rebooting, then trying again, would sometimes solve the issue. Trying to play a trailer before trying to play the movie seemed to increase chances of the Apple TV actually downloading the movie, too.</p>
<p>Finally, some forum or other pointed me to the correct solution: For some reason, the Apple TV did not play nice with our ISP DNS server. Simply ...</p> <a class="btn btn-info xsmall" href="./an-error-occurred-loading-this-content-try-again-later.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./names.html"><h2>Names</h2></a>
        <div class= "well small"> 28/10/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><blockquote>
<p>Names are everywhere in software. We name our variables, our functions, our arguments, classes, and packages. We name our source files and the directories that contain them. We name our jar files and war files and ear files. We name and name and name. Because we do so much of it, we'd better do it well.</p>
</blockquote>
<p>-- from the Introduction to chapter 2 "Meaningful Names" of "Clean Code" by Robert C. Martin.</p>
<p>Indeed we name a lot of things in software. As The Structure and Interpretation of Computer Programs points out, the primary purpose of a function (lambda) is to ...</p> <a class="btn btn-info xsmall" href="./names.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./matlab-mex-homebrew-and-os-x-108-mountain-lion.html"><h2>Matlab, Mex, Homebrew and OS X 10.8 Mountain Lion</h2></a>
        <div class= "well small"> 20/10/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>Now that I am a student again, I have to use Matlab again. Among the many joys of Matlab is the compilation of mex files.</p>
<p>Because it does not work. So angry.</p>
<p>Basically, <code>mex</code> does not work because it assumes that you have OS X 10.6 installed. In OS X 10.6 you had <code>gcc-4.2</code> and your system SDK was stored in <em>/Developer/SDKs/MacOSX10.6.sdk</em>. However, as of 10.7 (I think), the <em>/Developer</em> directory has been deprecated in favor of distributing the whole development environment within the App package of XCode. Also, <code>gcc</code> has been ...</p> <a class="btn btn-info xsmall" href="./matlab-mex-homebrew-and-os-x-108-mountain-lion.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./my-emacs-customizations.html"><h2>My Emacs customizations</h2></a>
        <div class= "well small"> 14/10/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>I don't host my <code>.emacs</code> in a repository. I tried it for a while, but it did not work for me. I think repos are great for managing multiple divergent versions of the same source tree. However, my dotfiles should never diverge, they should just be kept in sync. This is what Dropbox is great at. So I use Dropbox instead of git.</p>
<p>One downside of that is that it is not as easy to provide a public link to my dotfiles. Or maybe it is. Here goes</p>
<p><a href="https://dl.dropbox.com/s/0ne31wkur81wgzb/.emacs">My <em>.emacs</em></a></p>
<p>Now on to the meat of this post: Some ...</p> <a class="btn btn-info xsmall" href="./my-emacs-customizations.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./text-editing-with-confidence-and-emacs.html"><h2>Text editing with confidence and Emacs</h2></a>
        <div class= "well small"> 13/10/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>In college, I realized for the first time how a good text editor could save me serious time, when I dragged an image file into Textmate and it auto-inserted all the LaTeX boilerplate for a figure. A few years later, on my first job, I learned <a href="http://www.viemu.com/">Vim key bindings for Visual Studio</a> because I hated text editing in Visual Studio so much. This showed me another way how a good text editor could save me serious time. A year after that, I was bored and tried Emacs. With Emacs, I discovered the marvelous world of <a href="https://en.wikipedia.org/wiki/REPL">REPLs</a> and <a href="http://orgmode.org/">outlining</a>.</p>
<p>Note that ...</p> <a class="btn btn-info xsmall" href="./text-editing-with-confidence-and-emacs.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./a-story-about-schemes.html"><h2>A Story about Schemes</h2></a>
        <div class= "well small"> 20/09/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p><strong>Disclaimer:</strong> If you are a programmer, or wanting to be a programmer, or interested in programming, or, well, reading this, you should absolutely, positively watch the 1986 MIT lecture about <a href="http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-001-structure-and-interpretation-of-computer-programs-spring-2005/">The Structure and Interpretation of Computer Programs</a>. (Most conveniently available <a href="http://ia600401.us.archive.org/8/items/MIT_Structure_of_Computer_Programs_1986/">here</a>)</p>
<p>I tried reading <a href="http://mitpress.mit.edu/sicp/full-text/book/book.html">the book</a> numerous times, but it was too dry for my taste. The lecture however is juicy, brain-bending bliss. Especially if you don't know much functional programming yet. It certainly blew my mind. Frequently. Like, every ten minutes. Basically, I feel reborn as a programmer, with a new sense of what I am doing and ...</p> <a class="btn btn-info xsmall" href="./a-story-about-schemes.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./kindleapp-not-starting-on-a-case-sensitive-file-system.html"><h2>Kindle.app not starting on a case-sensitive file system</h2></a>
        <div class= "well small"> 13/09/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>So Kindle.app was updated through the App Store and did not start any more. It just crashed and the crash reporter came up.</p>
<p>A quick look at Console.app turns up a link to the actual crash report. And the crash report starts with</p>
<div class="codehilite"><pre><span class="n">Dyld</span> <span class="n">Error</span> <span class="n">Message</span><span class="p">:</span>
  <span class="n">Library</span> <span class="n">not</span> <span class="n">loaded</span><span class="p">:</span> <span class="p">@</span><span class="n">executable_path</span><span class="o">/</span><span class="p">.</span><span class="o">./</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">libWEbCoreKRF</span><span class="p">.</span><span class="n">dylib</span>
  <span class="n">Referenced</span> <span class="n">from</span><span class="p">:</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Kindle</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">Contents</span><span class="o">/</span><span class="n">Frameworks</span><span class="o">/</span><span class="n">libWebCoreViewer</span><span class="p">.</span><span class="n">dylib</span>
  <span class="n">Reason</span><span class="p">:</span> <span class="n">image</span> <span class="n">not</span> <span class="n">found</span>
</pre></div>


<p><code>libWEbCoreKRF.dylib</code>? With a capitalized <code>E</code>? That looks very much like a spelling error. So, point your terminal to <code>/Applications/Kindle.app/Contents/Frameworks/</code>, type</p>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">libWebCoreKRF</span><span class="p">.</span><span class="n">dylib</span> <span class="n">libWEbCoreKRF</span><span class="p">.</span><span class="n">dylib ...</span></pre></div> <a class="btn btn-info xsmall" href="./kindleapp-not-starting-on-a-case-sensitive-file-system.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./on-the-virtue-of-contributing-to-and-using-open-source-software.html"><h2>On the Virtue of Contributing to and Using Open Source Software</h2></a>
        <div class= "well small"> 08/09/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>I am a mostly self-taught programmer. Apart from a few programming side jobs at the university, I have been programming professionally for the last two and a half years.</p>
<p>About two years ago, we wanted to buy a Matlab license for our company. However, our investors declined for dubious reasons. So I started looking for alternatives. Inspired by a good friend (thank you, Marc), I looked into Python. Python has this brilliant environment for <a href="http://numpy.scipy.org/" title="NumPy">numerical</a> <a href="http://scipy.org/" title="SciPy">computation</a> and <a href="http://matplotlib.sourceforge.net/" title="matplotlib">plotting</a> that, for my particular purposes, rivals Matlab.</p>
<p>However, just like Matlab, Python lacked a way of playing real time audio out of ...</p> <a class="btn btn-info xsmall" href="./on-the-virtue-of-contributing-to-and-using-open-source-software.html">read more</a></div>
    </div>	
				
    

 

        


 

    <div class='article'>
        <a href="./fixing-errors-in-epydoc.html"><h2>Fixing Errors in Epydoc</h2></a>
        <div class= "well small"> 28/08/2012


by <a class="url fn" href="./author/bastian-bechtold.html">Bastian Bechtold</a>
 



 </div>
        <div class="summary"><p>I ran into this error twice now and wasted an hour both times, so it is time to put this on my universal scratchpad, i.e. this blog.</p>
<p>If you ever get this error when using <a href="http://epydoc.sourceforge.net/">epydoc</a>:</p>
<div class="codehilite"><pre><span class="n">UNEXPECTED</span> <span class="n">ERROR</span><span class="p">:</span>
<span class="s">&#39;Text&#39;</span> <span class="n">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">&#39;data&#39;</span>
</pre></div>


<p>You are probably running a version of Python that is greater than the latest one that is supported by epydoc. This is because epydoc has not been updated since 2008 and Python 2.5.</p>
<p>Luckily, some <a href="http://www.agapow.net/programming/python/epydoc-go-boom">fine</a> <a href="http://stackoverflow.com/questions/6704770/epydoc-attributeerror-text-object-has-no-attribute-data">folks</a> on the internet have figured out how to fix these things.</p>
<p>Short answer: Find your <em>site-packages</em> directory ...</p> <a class="btn btn-info xsmall" href="./fixing-errors-in-epydoc.html">read more</a></div>
    </div>	
				
    
        <div class="pagination">
<ul>

    <li class="prev disabled"><a href="#">&larr; Previous</a></li>



    <li class="active"><a href="./index.html">1</a></li>

    <li class=""><a href="./index2.html">2</a></li>

    <li class=""><a href="./index3.html">3</a></li>

    <li class=""><a href="./index4.html">4</a></li>



    <li class="next"><a href="./index2.html">Next &rarr;</a></li>


</ul>
</div>
    

 

 
 


        </div>

        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Site
                </li>

                <li><a href="./archives.html">Archives</a>
                <li><a href="./tags.html">Tags</a>
                <li><a href="./" rel="alternate">Atom feed</a></li>
                
                <li><a href="./feeds/all.rss.xml" rel="alternate">RSS feed</a></li>
                
            </ul>
            </div>


            
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Categories
                </li>

                
                <li><a href="./category/all.html">all</a></li>
                
            </ul>
            </div>
            


            


            
            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Social
                </li>

                
                <li><a href="http://twitter.com/paperflyer">twitter</a></li>
                
                <li><a href="http://github.com/bastibe">github</a></li>
                
            </ul>
            </div>
            </div>
            

        </div> 
    </div> 
    </div> 

<footer>
<br />
<p><a href=".">Bastis Scratchpad On The Internet</a> &copy; Bastian Bechtold 2012</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>


<a href="http://github.com/bastibe/"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>

</body>
</html>