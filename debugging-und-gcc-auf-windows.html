<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>Debugging und GCC auf Windows - Das Krachen</title>	
	<meta name="author" content="Bastian Bechtold">
	
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0">
	
	<link href='http://fonts.googleapis.com/css?family=Droid+Sans:700,400|Droid+Sans+Mono' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
		
	<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
	
	
	
	<link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Das Krachen ATOM Feed" />
	
	<link href="./feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="Das Krachen RSS Feed" />
	
</head>
	
<body>		
	<header class="clearfix" role="banner">
		<div class="wrapper">
			<h1 class="huge"><a href=".">Das Krachen</a></h1>
		</div>
	</header>
	
	
<div role="main" class="content clearfix">	
	<article>
		<div class="post wrapper">
			<h1>Debugging und GCC auf Windows</h1>
			<p><img alt="Code" src="static/images/2009-03/code.png" /></p>
<p>So, jetzt habe ich mein Mex-File zum Einlesen beliebiger Audiodateien endlich lauffähig auf Windows und Mac. Leider werde ich nicht dafür bezahlt, auch noch eine Linux-Version zu bauen, aber falls Interesse besteht, versuche ich mich vielleicht einmal daran.</p>
<p><a href="http://en.wikipedia.org/wiki/State_of_the_Union">The State of The Union</a>: Kleine Dateien einlesen, kein Problem. Exotische Formate einlesen, kein Problem. Metadaten auslesen, kein Problem. Dateigröße, Bitrate und Samplerate auslesen, ein kleines Problem, da diese Parameter bei komprimierten Formaten nicht unbedingt fest stehen. Große Dateien einlösen, auf dem Mac kein Problem, auf Windows… nun ja, es dauert. Eine WAV-Datei von 5:30 min einzulesen, dauert mit Windows momentan ca. eine Stunde. Das kann nicht sein, in der Zeit habe ich die Datei dem Programm vorgelesen, wenn es sein muss.</p>
<p>Also, was ist da faul? Jetzt heißt es debuggen: <a href="http://de.wikipedia.org/wiki/GNU_Debugger">GDB</a> ist mein Freund, aber leider spreche ich seine Sprache nicht, also Oldschool-Debugging mit <a href="http://www.cplusplus.com/reference/clibrary/cstdio/printf.html">printf()</a> (bzw. <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/index.html?/access/helpdesk/help/techdoc/apiref/mexprintf.html">mexPrintf()</a>; Aber da <code>#define printf mexPrintf</code> ist das das selbe). Blöd nur, dass Matlab selbst entscheidet, wann es meine Printfs auf den Bildschirm schreibt und es sich dazu entschlossen hat, dies immer erst nach dem Ausführen der Datei, also erst nachdem es bereits eine Stunde gearbeitet hat, zu tun. Einiges Hirnen später konnte ich Matlab endlich über eine Kombination aus <a href="http://de.wikipedia.org/wiki/Typumwandlung">Typecasts</a>, <a href="http://www.cplusplus.com/reference/clibrary/cstdio/sprintf.html">sprintf</a> und <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/index.html?/access/helpdesk/help/techdoc/apiref/mexwarnmsgtxt.html">mexWarnMsgTxt</a> dazu überreden, wenigstens sporadisch ein paar Informationen herauszugeben.</p>
<p>Das Ergebnis:</p>
<ol>
<li>Die Datei funktioniert tadellos, ist nur ein wenig langsam (s.o.)</li>
<li>Wer ist schuld? <a href="http://www.cplusplus.com/reference/clibrary/cstdlib/realloc.html">Realloc</a> ist schuld!</li>
</ol>
<p>Das kam überraschend! Offenbar ist realloc auf dem Mac um mehrere Größenordnungen performanter als auf <a href="http://www.mingw.org/">MinGW</a>/Windows, denn die selbe Anwendung, die auf dem Mac ca. eine Sekunde braucht, braucht auf Windows eine Stunde! Und das allein wegen realloc! (Eigentlich: eine halbe Stunde wegen realloc, der Rest ist der Tatsache geschuldet, dass Windows in einer <a href="http://www.vmware.com/de/products/fusion/">VM</a> läuft)</p>
<p>Bei WAV-Dateien werden immer 2048 Samples an einem Stück ausgelesen. Danach verwende ich ein realloc, um meinen haupt-Speicherpuffer um diese Größe zu vergrößern und kopiere die neuen Daten dort hinein. Bei meinen 5:30 min macht das bei einer Samplerate von 44100 kHz und zwei Kanälen ca. 15000 Aufrufe von realloc. Komprimierte Datenformate haben üblicherweise kleinere Frames und damit noch einmal wesentlich mehr realloc-Aufrufe.
Der Plan ist also, jetzt statt häufiger, kleiner realloc-Aufrufe, seltenere, größere Aufrufe zu machen. Zeit für ein paar Experimente:</p>
<div class="codehilite"><pre><span class="n">realloc</span><span class="p">()</span><span class="o">-</span><span class="n">Gr</span>öß<span class="n">e</span>   <span class="n">realloc</span><span class="p">()</span><span class="o">-</span><span class="n">Aufrufe</span>   <span class="n">ben</span>ö<span class="n">tigte</span> <span class="n">Zeit</span>
2^11 <span class="p">=</span> 2048       15000               <span class="o">~</span>1 <span class="n">h</span>
2^16 <span class="p">=</span> 65536      470                 <span class="o">~</span>2 <span class="n">min</span>
2^17 <span class="p">=</span> 131072     240                 <span class="o">~</span>1 <span class="n">min</span>
2^18 <span class="p">=</span> 262144     120                 30 <span class="n">s</span>
2^19 <span class="p">=</span> 524288     60                  18 <span class="n">s</span>
2^20 <span class="p">=</span> 1048576    30                  10<span class="p">.</span>5 <span class="n">s</span>
2^21 <span class="p">=</span> 2097152    15                  7<span class="p">.</span>3 <span class="n">s</span>
2^22 <span class="p">=</span> 4194304    7                   5<span class="p">.</span>1 <span class="n">s</span>
2^23 <span class="p">=</span> 8388608    3                   4<span class="p">.</span>2 <span class="n">s</span>
</pre></div>


<p>Das Spannende ist: Ich ändere durch meine Methodik praktisch nichts außer der Anzahl und Größe der realloc-Aufrufe, aber man erkennt einen eindeutigen Zusammenhang zwischen Performance und Anzahl der Aufrufe, ergo ist realloc der alleinige Schuldige für mein Performanceproblem auf Windows.</p>
<p>An dieser Stelle fiel mir ein, dass ich bereits an früherer Stelle einmal die gesamte Länge des Audio-Streams anhand der Metadaten geschätzt hatte. Durch eine somit vorgenommene Prä-Allokation des gesamten Speichers lässt sie die Laufzeit weiter auf 2.2 s drücken. Das ist immernoch nicht einmal halb so schnell wie auf OSX (0.9 s), aber das mag auch an der virtuellen Maschine liegen.</p>
<p>Mehr als diesen anecdotal Evidence kann ich nicht anbieten, aber ich bin mir sicher, dass ich ab jetzt die Finger von inkrementiellen Speichervergrößerungen auf MinGW/Windows lassen werde. Ist das in MSVC ähnlich schlimm, oder habe ich da etwa einen Bug entdeckt?</p>
			
			<a href="https://twitter.com/share" class="twitter-share-button" data-via="paperflyer" data-lang="en" data-size="large" data-related="paperflyer">Tweet</a>
			<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
						
			
			<div class="comments">
			<h2>Comments !</h2>
			    <div id="disqus_thread"></div>
			    <script type="text/javascript">
			       var disqus_identifier = "debugging-und-gcc-auf-windows.html";
			       (function() {
			       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			       dsq.src = 'http://bastibe.disqus.com/embed.js';
			       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			      })();
			    </script>
			</div>
						
		</div>
	
	<div class="meta wrapper">
	<time datetime="2009-03-15T15:10:00" pubdate>Sun 15 March 2009</time>
	<ul class="tag clearfix">
		<li><a href="./">misc</a></li>

	
		<li><a href="./">compiling</a></li>
	
		<li><a href="./">computers</a></li>
	

	</ul>
	
</div>
	</article>	
</div>

	
		
<footer class="clearfix">
	<div class="wrapper pages">
		<ul class="nav">
		
			<li><a href="./archives.html">Archive</a></li>
		</ul>
	</div>
	
	<div class="copy wrapper">
		<ul class="social">
			
			<li><a href="http://twitter.com/paperflyer">twitter</a></li>
			
			<li><a href="http://github.com/bastibe">github</a></li>
			
		</ul>
	
		<p role="contentinfo">© 2012 Bastian Bechtold<br>
		Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a>.</p>
	</div>
</footer>
	
	<script>
	  var _gaq=[['_setAccount',''],['_trackPageview']];
	  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
	  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
	  s.parentNode.insertBefore(g,s)}(document,'script'));
	</script>
</body>
</html>